<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <script src="GoogleChart/js/jsapi.js"></script>
    <script src="Scripts/json2.js"></script>
    <script src="Scripts/layer/layer.js"></script>
    <script src="Scripts/GExtension.js"></script>
    <script src="Scripts/site.js"></script>
    <link href="GoogleChart/css/orgchart.css" rel="stylesheet" />
    <style type="text/css">
        body {
            font-family: 'Microsoft YaHei UI';
            font-size: 14px;
            margin: 0px;
            padding: 5px;
        }

        fieldset {
            padding: 5px;
            margin-top: 15px;
        }

        .temp {
            display: none;
        }

        .simple_layer {
            padding: 20px 20px 0px;
        }

        table .td-title {
            width: 5em;
            text-align: right;
        }

        .chart {
            margin: 5px 0px;
            border: solid 2px #b5d9ea;
            padding: 5px;
            cursor: pointer;
        }

        .selectchart {
            border: solid 2px #e3ca4b;
        }

        .bindchart {
            margin: 5px 0px;
            border: solid 2px #b5d9ea;
            padding: 5px;
            cursor: pointer;
            width: 20%;
            float: left;
        }

            .bindchart:nth-of-type(2n+2) {
                margin: 5px;
            }

        #div_forTable table {
            border: solid 2px #b5d9ea;
            cursor: pointer;
            padding: 5px;
            width: 99%;
            margin: 5px 5px 0px 0px;
            float: left;
            margin-left: 5px;
        }

            #div_forTable table th.tablebtn {
                width: 60px;
            }

            #div_forTable table:nth-of-type(2n) {
            }

            #div_forTable table.select {
                border: solid 2px #e3ca4b;
            }

            #div_forTable table.tree {
                width: 32%;
            }

        #div_bindform .chart_div {
            margin: 5px 0px;
            padding: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="template">
        <table id="json_objectName" class="temp simple_layer">
            <tr>
                <td class="td-title">对象名称：</td>
                <td><input type="text" id="txt_jsonObjectName" /> </td>
            </tr>
            <tr>
                <td class="td-title">Url：</td>
                <td><input type="text" id="txt_jsonUrl" /> </td>
            </tr>
            <tr>
                <td class="td-title">参数名：</td>
                <td><input type="text" id="txt_jsonParams" /> </td>
            </tr>
        </table>

        <!--用于新增Json-->
        <table id="json_propertyName" class="temp simple_layer">
            <tr>
                <td class="td-title">属性名称：</td>
                <td><input type="text" id="txt_jsonPropertyName" /> </td>
            </tr>
        </table>
        <!--用于新增Form控件节点-->
        <table id="form_propertyName" class="temp simple_layer">
            <tr>
                <td class="td-title">属性名称：</td>
                <td><input type="text" id="txt_formPropertyName" /> </td>
            </tr>
            <tr>
                <td class="td-title">显示名称：</td>
                <td><input type="text" id="txt_formShowName" /> </td>
            </tr>
            <tr>
                <td class="td-title">验证信息：</td>
                <td>
                    <table id="form_tab_validate">
                        <tr>
                            <td><input type="checkbox" name="required" id="validate_1" /> <label for="validate_1">非空</label></td>
                            <td><input type="checkbox" name="number" id="validate_2" /> <label for="validate_2">数字</label></td>
                            <td><input type="checkbox" name="numint" id="validate_3" /> <label for="validate_3">整数</label></td>
                            <td><input type="checkbox" name="email" id="validate_4" /> <label for="validate_4">Email邮箱</label></td>
                            <td><input type="checkbox" name="ipaddress" id="validate_5" /> <label for="validate_5">IP地址</label></td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" name="postcode" id="validate_6" /> <label for="validate_6">邮政编码</label></td>
                            <td><input type="checkbox" name="telnum" id="validate_7" /> <label for="validate_7">电话号码</label></td>
                            <td><input type="checkbox" name="idcard" id="validate_8" /> <label for="validate_8">身份证</label></td>
                            <td><input type="checkbox" name="lenvalidate" id="validate_9" /> <label for="validate_9">长度限制</label></td>
                            <td><input type="checkbox" name="regvalidate" id="validate_10" /> <label for="validate_10">正则</label></td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td class="td-title">尺  寸：</td>
                <td><input type="number" id="txt_formCtrSize" value="6" /> </td>
            </tr>
        </table>
        <!--用于新增Form Root节点-->
        <table id="form_primaryKey" class="temp simple_layer">
            <tr>
                <td class="td-title">主键名称：</td>
                <td><input type="text" id="txt_formPrimaryKey" /> </td>
            </tr>
            <tr>
                <td class="td-title">隐藏表单：</td>
                <td><input type="checkbox" id="cbx_hiddenForm" /> <label for="cbx_hiddenForm">是否隐藏</label></td>
            </tr>
            <tr>
                <td class="td-title">尺  寸：</td>
                <td><input type="number" id="txt_formSize" value="6" /></td>
            </tr>
            <tr id="form_tr_btns">
                <td class="td-title">提交按钮：</td>
                <td><span id="form_btns"></span><input type="button" value="添加" onclick="AddFormButtons()" /></td>
            </tr>
        </table>
        <!--用于新增Form提交按钮-->
        <table id="form_addbtns" class="temp simple_layer">
            <tr><td class="td-title">按钮文本：</td><td><input type="text" id="form_addbtntext" /></td></tr>
            <tr><td class="td-title">提交Url：</td><td><input type="text" id="form_addbtnaction" /></td></tr>
        </table>
        <!--用于编辑Form提交按钮-->
        <table id="form_editbtns" class="temp simple_layer" style="width:300px;min-height:100px;">
            <tr><td></td></tr>
        </table>
        <!--用于设置Form只读开关-->
        <table id="form_disabled" class="temp simple_layer">
            <tr><td class="td-title">只读Url：</td><td><input type="text" id="fm_disabled_url" /></td></tr>
            <tr><td class="td-title">描述：</td><td style="color:blue;font-size:12px;">*返回0|1，1:只读*</td></tr>
        </table>

        <!--用于维护长度验证的长度-->
        <table id="form_validateLength" class="temp simple_layer">
            <tr>
                <td class="td-title">最小长度：</td>
                <td><input type="number" id="txt_validateMinLength" /> </td>
            </tr>
            <tr>
                <td class="td-title">最大长度：</td>
                <td><input type="number" id="txt_validateMaxLength" /></td>
            </tr>
        </table>
        <!--用于维护长度验证的正则表达式-->
        <table id="form_validateReg" class="temp simple_layer">
            <tr>
                <td class="td-title">正则表达式：</td>
                <td><input type="number" id="txt_validateRegString" /> </td>
            </tr>
        </table>

        <!--用于新增Tree控件-->
        <table id="tree_addTree" class="temp simple_layer">
            <tr>
                <td class="td-title">节点名称-Field：</td>
                <td><input type="text" id="tree_nodeField" /></td>
                <td class="td-title">ParentID-Field：</td>
                <td><input type="text" id="tree_parentIdField" /></td>
            </tr>
            <tr>
                <td class="td-title">加载Url：</td>
                <td><input type="text" id="tree_loadUrl" /></td>
                <td class="td-title">保存Url：</td>
                <td><input type="text" id="tree_saveUrl" /></td>
            </tr>
            <tr>
                <td class="td-title">删除Url：</td>
                <td><input type="text" id="tree_delUrl" /></td>
                <td class="td-title"></td>
                <td></td>
            </tr>
        </table>
        <!--用于修改Tree的默认按钮-->
        <div id="tree_editdefaultbtns" class='temp simple_layer' style='width:300px;height:150px;padding:20px;'>
            <input type="checkbox" id="tree_dbtn1" data-role="addroot" /><label for="tree_dbtn1">新增根节点</label>
            <input type="checkbox" id="tree_dbtn2" data-role="add" /><label for="tree_dbtn2">新增</label>
            <input type="checkbox" id="tree_dbtn3" data-role="edit" /><label for="tree_dbtn3">编辑</label>
            <input type="checkbox" id="tree_dbtn4" data-role="delete" /><label for="tree_dbtn4">删除</label>
        </div>

        <!--设置表格查询-->
        <table id="table_search" class="temp simple_layer">
            <tr>
                <td><input type="button" value="新增" onclick="TableAddSearch()" /></td>
            </tr>
            <tr>
                <td style="width:300px;height:100px;" id="table_searchitemtd"></td>
            </tr>
        </table>
        <!--新增表格查询项-->
        <table id="table_searchitem" class="temp simple_layer" style="height:200px;">
            <tr><td class="td-title">标题：</td><td><input type="text" id="table_sitemtitle" /></td></tr>
            <tr><td class="td-title">查询属性：</td><td><input type="text" id="table_sitemproperty" /></td></tr>
            <tr>
                <td class="td-title">类型：</td>
                <td>
                    <select id="table_sitemtype" onchange="table_sitemtypechanged(this)">
                        <option value="1">文本</option>
                        <option value="2">下拉</option>
                        <option value="3">日期</option>
                    </select>
                </td>
            </tr>
            <tr style="display:none;">
                <td class="td-title">数据源：</td>
                <td>
                    <input type="text" readonly="readonly" id="table_sitembindjsonid" />
                    <br /><input type="button" value="绑定数据源" onclick="table_sitembindjson()" />
                </td>
            </tr>
        </table>

        <!--用于修改表格的默认按钮-->
        <div id="table_editdefaultbtns" class='temp simple_layer' style='width:300px;height:150px;padding:20px;'>
            <input type="checkbox" id="table_dbtn2" data-role="add" /><label for="table_dbtn2">新增</label>
            <span id="table_movemorespan">
                <input type="checkbox" id="table_dbtn3" data-role="movemore" onchange="table_setMoveMoreInfo(this)" /><label for="table_dbtn3">批量转移</label>
            </span>
        </div>

        <!--用于表格查询项Select绑定全局数据-->
        <div style="padding:20px;width:500px;height:250px;overflow-y:auto" id="div_bindform" class="temp">
        </div>

        <!--设置自定义按钮-->
        <table id="tt_custombtn" class="temp simple_layer">
            <tr>
                <td><input type="button" value="新增" onclick="ttAddCustomBtn()" /></td>
            </tr>
            <tr>
                <td style="width:300px;height:100px;" id="tt_custombtntd"></td>
            </tr>
        </table>
        <!--新增自定义按钮-->
        <table id="table_addcustombtn" class="temp simple_layer">
            <tr><td class="td-title">文本：</td><td><input type="text" id="table_cbtntext" /></td></tr>
            <tr><td class="td-title">提交Url：</td><td><input type="text" id="table_cbtnaction" /></td></tr>
        </table>

        <table id="tree_settablefk" class="temp simple_layer">
            <tr><td class="td-title">外键名称：</td><td><input type="text" id="table_fkname" /></td></tr>
        </table>

        <table id="table_settransferurl" class="temp simple_layer">
            <tr><td class="td-title">提交Url：</td><td><input type="text" id="table_transferurl" /></td></tr>
        </table>
    </div>

    <div>
        <div>
            <table width="100%">
                <tr>
                    <td>
                        <input type="button" value="添加Form" onclick="AddFormData()" />
                        <input type="button" value="添加全局数据" onclick="AddJsonData()" />
                        <input type="button" value="添加树" onclick="AddTree()" />
                        <input type="button" value="添加表格" onclick="AddTable()" />
                        <input type="button" value="添加绑定" onclick="AddDataBind()" />
                    </td>
                    <td align="right"></td>
                </tr>
            </table>
        </div>
        <fieldset>
            <legend>数据展示</legend>
            <div id="div_forTable"></div>
            <div style="clear:both;"></div>
        </fieldset>
        <fieldset>
            <legend>全局数据</legend>
            <div id="div_forJson"></div>
        </fieldset>
        <fieldset>
            <legend>表单</legend>
            <div id="div_forForm"></div>
        </fieldset>
        <fieldset>
            <legend>数据绑定</legend>
            <div id="div_forBind"></div>
        </fieldset>
    </div>

    <script type="text/javascript">
        $("#cbx_hiddenForm").bind('click', function () {
            if (this.checked) {
                $("#form_tr_btns").hide();
                $("#form_btns input").remove();
                $("#form_btns label").remove();
            }
            else {
                $("#form_tr_btns").show();
            }
        });

        function ttAddCustomBtn() {
            $("#table_addcustombtn").open("新增自定义按钮", function () {
                var text = $.trim($("#table_cbtntext").val());
                var action = $.trim($("#table_cbtnaction").val());
                if (text.length == 0 || action.length == 0) {
                    alert("请维护所有项！");
                    return false;
                }

                $("#table_cbtntext").val("");
                $("#table_cbtnaction").val("");
                var bid = Math.random().toString().split('.')[1];
                $("#tt_custombtntd").append('<input type="checkbox" id="' + bid + '" checked="checked" data-text="' + text + '" data-action="' + action + '" /> <label for="' + bid + '">' + text + '</label>');
            });
        }

        var temptrees = {};
        function AddTree() {
            $("#tree_addTree").open("添加树配置", function () {
                var nodeField = $.trim($("#tree_nodeField").val());
                var parentIdField = $.trim($("#tree_parentIdField").val());
                if (nodeField.length == 0) {
                    alert("请维护节点名称对应字段！");
                    return false;
                }

                if (parentIdField.length == 0) {
                    alert("请维护上级节点ID对应字段！");
                    return false;
                }

                var loadUrl = $.trim($("#tree_loadUrl").val());
                var saveUrl = $.trim($("#tree_saveUrl").val());
                var delUrl = $.trim($("#tree_delUrl").val());
                if (loadUrl.length == 0) {
                    alert("请维护加载Url！");
                    return false;
                }
                var tid = Math.random().toString().split('.')[1];

                AddTreeSubmit(tid, nodeField, parentIdField, loadUrl, saveUrl, delUrl, null);

                $("#tree_loadUrl").val("");
                $("#tree_saveUrl").val("");
                $("#tree_delUrl").val("");
            });
        }

        function AddTreeSubmit(tid, nodeField, parentIdField, loadUrl, saveUrl, delUrl, reftableid, defaultbtns) {
            if (!defaultbtns) {
                defaultbtns = ['addroot', 'add', 'edit', 'delete'];
            }

            /*添加树配置到界面---Start------*/
            var table = $('<table class="tree" id="tree_' + tid + '" cellpadding="0" cellspacing="0"><thead><tr><th>树控件</td></tr></thead></table>');
            var refBtn = $("<input type='button' value='关联到表格' />");
            refBtn.bind("click", function () {
                var stable = $("#div_forTable table.select");
                if (stable.length == 0) {
                    alert("请选中要关联到的表格！");
                    return;
                }

                $("#tree_settablefk").open("对应到Table中的外键名称", function () {
                    var fkname = $.trim($("#table_fkname").val());
                    if (fkname.length == 0) {
                        alert("请设置外键名称！");
                        return false;
                    }

                    var id = stable[0].id.split('_')[1];
                    temptrees[tid]["reftableid"] = id;
                    temptrees[tid]["reftablefk"] = fkname;
                    alert("关联成功。");
                });
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(refBtn));

            var changeBtn = $("<input type='button' value='修改默认按钮' />");
            changeBtn.bind('click', function () {
                var dbtns = temptrees[tid].defaultbtns;
                $("#tree_editdefaultbtns input[type=checkbox]").each(function () {
                    for (var i = 0; i < dbtns.length; ++i) {
                        if (dbtns[i] == $(this).attr("data-role")) {
                            this.checked = true;
                            return;
                        }
                        else {
                            if (this.checked) {
                                this.checked = false;
                            }
                        }
                    }
                });
                $("#tree_editdefaultbtns").open("编辑树默认按钮", function () {
                    temptrees[tid].defaultbtns = [];
                    $("#tree_editdefaultbtns input[type=checkbox]").each(function () {
                        if (this.checked) {
                            temptrees[tid].defaultbtns.push($(this).attr("data-role"));
                        }
                    });
                });
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(changeBtn));

            var customBtn = $("<input type='button' value='自定义按钮' />");
            customBtn.bind('click', function () {
                $("#tt_custombtntd input[type=checkbox]").each(function () {
                    $(this).next().remove();
                    $(this).remove();
                });

                var btns = temptrees[tid].custombtns;
                if (btns && btns.length > 0) {
                    for (var i = 0; i < btns.length; ++i) {
                        $("#tt_custombtntd").append('<input type="checkbox" id="tbtn' + i + '" checked="checked" data-text="' + btns[i].text + '" data-action="' + btns[i].action + '" /> <label for="tbtn' + i + '">' + btns[i].text + '</label>');
                    }
                }

                $("#tt_custombtn").open("自定义树操作按钮", function () {
                    temptrees[tid].custombtns = [];

                    $("#tt_custombtntd input[type=checkbox]").each(function () {
                        if (this.checked) {
                            temptrees[tid].custombtns.push({ id: Math.random().toString().split('.')[1], text: $(this).attr("data-text"), action: $(this).attr("data-action") });
                        }
                    });
                });
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(customBtn));

            var removeBtn = $("<input type='button' value='移除树' />");
            $(removeBtn).bind("click", function () {
                if (confirm("确定要移除该树控件吗？")) {
                    for (var i in temptrees) {
                        if (i == tid) {
                            temptrees[i] = undefined;
                            $("#tree_" + tid).remove();
                            return;
                        }
                    }
                }
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(removeBtn));

            $("#div_forTable").append(table);
            /*添加树配置到界面---End------*/

            temptrees[tid] = { id: tid, nodeField: nodeField, parentIdField: parentIdField, loadurl: loadUrl, saveurl: saveUrl, delurl: delUrl, defaultbtns: defaultbtns };
            if (reftableid) {
                temptrees[tid]["reftableid"] = reftableid;
            }
        }

        var layerTable = null;
        function AddTable() {
            layerTable = layer.open({
                title: ['添加表格配置'],
                type: 2,
                area: ['700px', '530px'],
                fix: false, //不固定
                maxmin: false,
                content: 'AddTableConfig.html'
            });
        }

        var temptables = {};
        function AddTableSubmit(tablejson, defaultbtns) {
            if (!defaultbtns) {
                defaultbtns = ['add'];
            }

            var tid = Math.random().toString().split('.')[1];
            var table = $('<table class="table" id="tbl_' + tid + '" cellpadding="0" cellspacing="0"><thead><tr></tr></thead></table>');
            for (var i in tablejson.headers) {
                table.find("tr").append("<th>" + tablejson.headers[i].header + "</th>");
            }

            var searchBtn = $("<input type='button' value='设置查询' />");
            searchBtn.bind("click", function () {
                $("#table_searchitemtd input[type=checkbox]").each(function () {
                    $(this).next().remove();
                    $(this).remove();
                });

                var sitems = temptables[tid].searchitems;
                if (sitems && sitems.length > 0) {
                    for (var i = 0; i < sitems.length; ++i) {
                        $("#table_searchitemtd").append('<input type="checkbox" id="sitem' + i + '" checked="checked" data-title="' + sitems[i].title + '" data-property="' + sitems[i].property + '" data-type="' + sitems[i].type + '" data-bindid="' + sitems[i].bindjsonid + '" /> <label for="sitem' + i + '">' + sitems[i].title + '</label>');
                    }
                }

                $("#table_search").open("设置表格查询", function () {
                    temptables[tid].searchitems = [];

                    $("#table_searchitemtd input[type=checkbox]").each(function () {
                        if (this.checked) {
                            temptables[tid].searchitems.push({ id: Math.random().toString().split('.')[1], title: $(this).attr("data-title"), property: $(this).attr("data-property"), type: $(this).attr("data-type"), bindjsonid: $(this).attr("data-bindid") });
                        }
                    });
                    if (temptables[tid].searchitems.length > 0) {
                        temptables[tid].searchid = Math.random().toString().split('.')[1];
                    }
                    else {
                        temptables[tid].searchid = "0";
                    }
                });
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(searchBtn));

            var changeBtn = $("<input type='button' value='修改默认按钮' />");
            changeBtn.bind('click', function () {
                if ($(".tree").length == 0) {
                    $("#table_movemorespan").hide();
                }
                else {
                    $("#table_movemorespan").show();
                }
                var dbtns = temptables[tid].defaultbtns;
                $("#table_editdefaultbtns input[type=checkbox]").each(function () {
                    for (var i = 0; i < dbtns.length; ++i) {
                        if (dbtns[i] == $(this).attr("data-role")) {
                            this.checked = true;
                            return;
                        }
                        else {
                            if (this.checked) {
                                this.checked = false;
                            }
                        }
                    }
                });
                $("#table_editdefaultbtns").open("编辑表格默认按钮", function () {
                    temptables[tid].defaultbtns = [];
                    $("#table_editdefaultbtns input[type=checkbox]").each(function () {
                        if (this.checked) {
                            var role = $(this).attr("data-role");
                            if (role == "movemore") {
                                temptables[tid].transferurl = $(this).attr("data-turl");
                            }
                            temptables[tid].defaultbtns.push($(this).attr("data-role"));
                        }
                    });
                });
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(changeBtn));

            var customBtn = $("<input type='button' value='自定义按钮' />");
            customBtn.bind('click', function () {
                $("#tt_custombtntd input[type=checkbox]").each(function () {
                    $(this).next().remove();
                    $(this).remove();
                });

                var btns = temptables[tid].custombtns;
                if (btns && btns.length > 0) {
                    for (var i = 0; i < btns.length; ++i) {
                        $("#tt_custombtntd").append('<input type="checkbox" id="tbtn' + i + '" checked="checked" data-text="' + btns[i].text + '" data-action="' + btns[i].action + '" /> <label for="tbtn' + i + '">' + btns[i].text + '</label>');
                    }
                }

                $("#tt_custombtn").open("自定义表格操作按钮", function () {
                    temptables[tid].custombtns = [];

                    $("#tt_custombtntd input[type=checkbox]").each(function () {
                        if (this.checked) {
                            temptables[tid].custombtns.push({ id: Math.random().toString().split('.')[1], text: $(this).attr("data-text"), action: $(this).attr("data-action") });
                        }
                    });
                });
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(customBtn));

            var removeBtn = $("<input type='button' value='移除表格' />");
            $(removeBtn).bind("click", function () {
                if (confirm("确定要移除该表格吗？")) {
                    temptables[tid] = undefined;
                }
            });
            table.find("tr").append($("<th class='tablebtn'></th>").append(removeBtn));

            $("#div_forTable").append(table);

            var tablejson = { id: tid, data: tablejson, searchid: "0", searchitems: [], defaultbtns: defaultbtns};
            temptables[tid] = tablejson;

            $("#div_forTable .table").each(function () {
                if (!$(this).attr("data-event")) {
                    $(this).attr("data-event", 1);
                    $(this).bind("click", function () {
                        var target = this;
                        $("#div_forTable .table").each(function () {
                            if (target != this) {
                                $(this).removeClass("select");
                            }
                            else {
                                if (!$(this).hasClass("select")) {
                                    $(this).addClass("select");
                                }
                            }
                        });
                    });
                }
            });

            layer.close(layerTable);

            return tablejson;
        }

        function table_setMoveMoreInfo(src) {
            if (src.checked) {
                $("#table_settransferurl").open("设置批量转移提交Url", function () {
                    var url = $.trim($("#table_transferurl").val());
                    if (url.length == 0) {
                        alert("请输入批量转移提交Url！");
                        return false;
                    }

                    $("#table_transferurl").val("");

                    $(src).attr("data-turl", url);
                });
            }
        }

        function TableAddSearch() {
            $("#table_searchitem").open("新增查询项", function () {
                var title = $.trim($("#table_sitemtitle").val());
                var property = $.trim($("#table_sitemproperty").val());
                var type = $("#table_sitemtype").val();
                var bindjsonid = $("#table_sitembindjsonid").val();
                if (title == 0 || property.length == 0 || (type == 2 && bindjsonid.length == 0)) {
                    alert("请维护所有项！");
                    return false;
                }

                $("#table_sitemtitle").val("");
                $("#table_sitemproperty").val("");
                $("#table_sitemtype").val(1);
                $("#table_sitembindjsonid").val("");
                $("#table_sitembindjsonid").parent().parent().hide();

                var id = Math.random().toString().split('.')[1];
                $("#table_searchitemtd").append('<input type="checkbox" id="' + id + '" checked="checked" data-title="' + title + '" data-property="' + property + '" data-type="' + type + '" data-bindid="' + bindjsonid + '" /> <label for="' + id + '">' + title + '</label>');
            });
        }

        function table_sitemtypechanged(src) {
            if ($(src).val() == 2) {
                $("#table_sitembindjsonid").val("");
                $(src).parent().parent().next().show();
            }
            else {
                $(src).parent().parent().next().hide();
            }
        }

        function table_sitembindjson() {
            $("#div_bindform .chart_div").remove();

            $("#div_forJson .chart").each(function () {
                var chart = jConfigs["#" + $(this)[0].id];
                var rows = eval('(' + chart.data.toJSON() + ')').rows;
                $("#div_bindform").drawChart(rows);

                $("#div_bindform .chart_div").each(function () {
                    var target = this;
                    $(this).bind('click', function () {
                        $("#div_bindform .chart_div").each(function () {
                            if (target == this) {
                                $(this).addClass("selectchart");
                            }
                            else {
                                $(this).removeClass("selectchart");
                            }
                        });
                    });
                });
            });

            $("#div_bindform").open("绑定数据源配置", function () {
                if ($("#div_bindform .selectchart").length == 0 || $("#div_bindform .selectchart .google-visualization-orgchart-nodesel").length == 0) {
                    $.alert("请选中数据源节点！");
                    return false;
                }
                else {
                    var title = $("#div_bindform .selectchart .google-visualization-orgchart-nodesel").attr("title");
                    var strs = title.split('_');
                    var type = strs[2];
                    if (type != 2) {
                        $.alert("请选中数组类型节点！");
                        return false;
                    }
                    $("#table_sitembindjsonid").val(strs[1]);
                }
            });
        }

        function AddJsonData() {
            $("#json_objectName").open("设置Json对象名称", function () {
                var name = $.trim($("#txt_jsonObjectName").val());
                var url = $.trim($("#txt_jsonUrl").val());
                if (name.length == 0) {
                    alert("请输入对象名称！");
                    return false;
                }
                if (url.length == 0) {
                    alert("请输入获取对象Url！");
                    return false;
                }

                $("#txt_jsonObjectName").val("");
                $("#txt_jsonUrl").val("");
                var id = Math.random().toString().split('.')[1];

                var params = [];
                var paramstr = $("#txt_jsonParams").val();
                if (paramstr.length > 0) {
                    paramstr = paramstr.split(",");
                    $(paramstr).each(function () {
                        params.push($.trim(this));
                    });
                }

                AddJsonDataSubmit(id, url, name, params);
            });
        }

        function AddJsonDataSubmit(id, url, name, params) {
            var selector = "chart_" + id;
            var chardiv = $("<div id='" + selector + "' class='chart'></div>");
            chardiv.attr("data-url", url);
            $("#div_forJson").append(chardiv);
            var chart = new jsonconfig('#' + selector, id, name + " {}");
            chart.params = params;

            BindChartContentEvent();

            return chart;
        }

        function AddFormData() {
            $("#form_primaryKey").open("添加表单配置", function () {
                var name = $.trim($("#txt_formPrimaryKey").val());
                if (name.length == 0) {
                    alert("请输入主键名称！");
                    return false;
                }

                var size = 0;
                try {
                    size = parseInt($.trim($("#txt_formSize").val()));
                }
                catch (e) {
                    alert("请输入表单尺寸！");
                    return false;
                }

                $("#txt_formPrimaryKey").val("");
                $("#txt_formSize").val(6);

                var id = Math.random().toString().split('.')[1];
                var isshow = $("#cbx_hiddenForm")[0].checked ? 0 : 1;

                var btns = [];
                $("#form_btns input[type=checkbox]").each(function () {
                    if (this.checked) {
                        btns.push({ id: this.id, txt: $(this).attr("data-txt"), action: $(this).attr("data-action") });
                    }
                });
                AddFormDataSubmit(id, isshow, name, size, btns);
            });
        }

        function AddFormDataSubmit(id, isshow, name, size, btns) {
            var selector = "chart_" + id;
            $("#div_forForm").append($("<div id='" + selector + "' class='chart'></div>"));

            var form = new formconfig('#' + selector, id, name, isshow, size, btns);
            form.beforeRemoveForm = function (fid) {
                var existstable = false;
                //检查是否存在表格绑定到该Form
                $(temptables).each(function () {
                    $(this.data.headers).each(function () {
                        if (this.type == "2") {
                            $(this.actionbtns).each(function () {
                                if (this.formdataid == id) {
                                    alert("删除失败，存在Table操作项绑定到该Form！");
                                    existstable = true;
                                }
                            });
                        }
                    });
                });

                if (existstable) {
                    return false;
                }

                //检查绑定
                $("#div_forBind .bindchart").each(function () {
                    var bind = $(this).bconfig();
                    if (bind.formid == id) {
                        var yes = confirm("该Form存在数据绑定，是否同时删除该数据绑定？");
                        if (yes) {
                            bind.btn_remove.click();
                        }
                    }
                });

                return true;
            };

            BindChartContentEvent();

            return form;
        }

        function AddFormButtons(btncontainerselector) {
            var btncontainer = null;
            if (!btncontainerselector) {
                btncontainer = $("#form_btns");
            }
            else {
                btncontainer = $(btncontainerselector);
            }

            $("#form_addbtns").open("添加按钮", function () {
                var txt = $.trim($("#form_addbtntext").val());
                var action = $.trim($("#form_addbtnaction").val());
                if (txt.length == 0 || action.length == 0) {
                    alert("请维护所有内容！");
                    return false;
                }

                $("#form_addbtntext").val("");
                $("#form_addbtnaction").val("");
                var id = Math.random().toString().split('.')[1];
                btncontainer.append('<input type="checkbox" id="' + id + '" checked="checked" data-txt="' + txt + '" data-action="' + action + '" /> <label for="' + id + '">' + txt + '</label>');
            });
        }

        function AddDataBind() {
            var jchart = $("#div_forJson .selectchart");
            if (jchart.length == 0) {
                alert("请选中数据源区域！");
                return;
            }
            var fchart = $("#div_forForm .selectchart");
            if (fchart.length == 0) {
                alert("请选中目标控件区域！");
                return;
            }

            jchart = $("#" + jchart[0].id).jconfig();
            fchart = $("#" + fchart[0].id).fconfig();
            if (!jchart.selectNode) {
                alert("请选中数据源区域节点！");
                return;
            }
            if (!fchart.selectNode) {
                alert("请选中目标控件区域节点！");
                return;
            }

            if ((jchart.selectNode.type == 1 || jchart.selectNode.type == -1) && fchart.selectNode.type == -1) {
                var id = Math.random().toString().split('.')[1];
                AddDataBindSubmit(id, jchart, fchart, 1);
            }
            else if (jchart.selectNode.type == 2 && fchart.selectNode.type == 1) {
                var id = Math.random().toString().split('.')[1];
                AddDataBindSubmit(id, jchart, fchart, 2);
            }
            else {
                alert("选中的节点类型不匹配！");
                return;
            }
        }

        function AddDataBindSubmit(id, jchart, fchart, type) {
            var selector = "chart_" + id;
            $("#div_forBind").append($("<div id='" + selector + "' class='bindchart'></div>"));
            //数组绑定到select控件
            var jnid = '', fnid = '', jntext = '', fntext = '', jntype = '', fntype = '';
            if (jchart) {
                jnid = jchart.selectNode.id;
                jntext = jchart.selectNode.text;
                jntype = jchart.selectNode.type;
            }
            if (fchart) {
                fnid = fchart.selectNode.id;
                fntext = fchart.selectNode.text;
                fntype = fchart.selectNode.type;
            }

            var chart = new bindconfig(jnid, fnid, jntext, fntext, jntype, fntype, "#" + selector, type);
            return chart;
        }

        function BindChartContentEvent() {
            $("#div_forJson .chart").each(function () {
                if (!this.onclick) {
                    $(this).bind('click', function () {
                        $("#div_forJson .chart").each(function () {
                            if ($(this).hasClass("selectchart")) {
                                $(this).removeClass("selectchart");
                            }
                        });

                        $(this).addClass("selectchart");
                    });
                }
            });
            $("#div_forForm .chart").each(function () {
                if (!this.onclick) {
                    $(this).bind('click', function () {
                        $("#div_forForm .chart").each(function () {
                            if ($(this).hasClass("selectchart")) {
                                $(this).removeClass("selectchart");
                            }
                        });

                        $(this).addClass("selectchart");
                    });
                }
            });
        }

        function Save() {
            //构造页面数据
            var content = { trees: [], tables: [], jsons: [], forms: [], binds: [] };

            for (var i in temptrees) {
                if (temptrees[i]) {
                    content.trees.push(temptrees[i]);
                }
            }

            for (var i in temptables) {
                if (temptables[i]) {
                    content.tables.push(temptables[i]);
                }
            }

            $("#div_forJson .chart").each(function () {
                var id = this.id.split('_')[1];
                var url = $(this).attr("data-url");
                var chart = $(this).jconfig();
                var data = JSON.parse(chart.data.toJSON()).rows;
                content.jsons.push({ id: id, url: url, data: data, parameters: chart.params });
            });

            $("#div_forForm .chart").each(function () {
                var id = this.id.split('_')[1];
                var chart = $(this).fconfig();
                var data = JSON.parse(chart.data.toJSON()).rows;
                content.forms.push({ id: id, isshow: chart.isshow, disabledurl: chart.disabledurl, size: chart.size, data: data, extdata: chart.extData, btns: chart.btns });
            });

            $("#div_forBind .bindchart").each(function () {
                var id = this.id.split('_')[1];
                var chart = $(this).bconfig();
                var data = JSON.parse(chart.data.toJSON()).rows;
                content.binds.push({ id: id, data: data, type: chart.type });
            });

            window.external.SaveToFile(JSON.stringify(content));
        }

        function InitUI(jsonstr) {
            var json = JSON.parse(jsonstr);

            $(json.trees).each(function () {
                AddTreeSubmit(this.id, this.nodeField, this.parentIdField, this.loadurl, this.saveurl, this.delurl, this.reftableid, this.defaultbtns);
            });

            $(json.tables).each(function () {
                var json = AddTableSubmit(this.data, this.defaultbtns);
                json.searchid = this.searchid;
                json.searchitems = this.searchitems;
                json.transferurl = this.transferurl;
            });

            $(json.jsons).each(function () {
                var chart = AddJsonDataSubmit(this.id, this.url, "", this.parameters);
                var data = InitChartData(this.data);
                chart.data = data;
                chart.chart.draw(data, { allowHtml: true, allowCollapse: true, size: "large" });
                chart.bindNodeSelectEvent();
            });

            $(json.forms).each(function () {
                var chart = AddFormDataSubmit(this.id, this.isshow, '', this.size, this.btns);
                chart.disabledurl = this.disabledurl;
                chart.extData = this.extdata;
                var data = InitChartData(this.data);
                chart.data = data;
                chart.chart.draw(data, { allowHtml: true, allowCollapse: true, size: "large" });
                chart.bindNodeSelectEvent();
            });

            $(json.binds).each(function () {
                var data = InitChartData(this.data);
                var chart = AddDataBindSubmit(this.id, null, null, this.type);
                chart.data = data;
                chart.chart.draw(data, { allowHtml: true, allowCollapse: true, size: "large" });
            });
        }

        function InitChartData(rows) {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Name');
            data.addColumn('string', 'Manager');
            data.addColumn('string', 'title');

            var nrows = [];
            for (var i in rows) {
                nrows[nrows.length] = [rows[i].c[0], rows[i].c[1].v, rows[i].c[2].v];
            }
            data.addRows(nrows);
            return data;
        }

        $(function () {
            $("#validate_9").bind("click", function () {
                var ctr = this;
                if (this.checked) {
                    $("#form_validateLength").open("维护最小最大长度", function () {
                        var minlen = parseInt($.trim($("#txt_validateMinLength").val()));
                        if (!minlen) {
                            minlen = '--';
                        }
                        var maxlen = parseInt($.trim($("#txt_validateMaxLength").val()));
                        if (!maxlen) {
                            maxlen = '++';
                        }

                        $("#txt_validateMinLength").val("");
                        $("#txt_validateMaxLength").val("");

                        $(ctr).attr("data-minlen", minlen);
                        $(ctr).attr("data-maxlen", maxlen);
                    }, function () {
                        ctr.checked = false;
                    }, true, false);
                }
                else {
                    $(this).removeAttr("data-minlen");
                    $(this).removeAttr("data-maxlen");
                }
            });

            $("#validate_10").bind("click", function () {
                var ctr = this;
                if (this.checked) {
                    $("#form_validateReg").open("维护正则表达式", function () {
                        var regstr = $.trim($("#txt_validateRegString").val());
                        $("#txt_validateRegString").val("");
                        $(ctr).attr("data-reg", regstr);
                    }, function () {
                        ctr.checked = false;
                    }, true, false);
                }
                else {
                    $(this).removeAttr("data-reg");
                }
            });
        });
    </script>
</body>
</html>