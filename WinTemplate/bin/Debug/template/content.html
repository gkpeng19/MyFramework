@Include("tables",Model)

@foreach(var fm in Model.forms)
{
    var style=fm.isshow=="0"?"display:none;":"";
	var hide=fm.isshow=="0"?"_hide":"";
	<div class="row-fluid">
		<div class="span@(fm.size)">
			<form  name="@fm.id" id="@fm.id" class="form-layer" style="@style">
				<div>
					<input type="hidden" name="@fm.data[1].c[0].fld" />
					<div class="row-fluid">
					@for(var index=2;index<fm.data.Count;++index) 
					{
						var d=fm.data[index];
						var t=d.c[2].t;
						foreach(var exd in fm.extdata.extdatas)
						{
							if(exd!=null&&exd.dataid==d.c[0].v)
							{
								<div class="span@(exd.size)">
								<label>@exd.showname</label>
								@if(t=="0")
								{
								<input type="text" name="@d.c[0].fld" id="@d.c[0].v" class="span11" />
								}
								else if(t=="1")
								{
								<select name="@d.c[0].fld" id="@d.c[0].v" class="span11"></select>
								}
								else if(t=="2")
								{
								<input type="text" name="@d.c[0].fld" id="@d.c[0].v" class="span11" />
								}
								else if(t=="3")
								{
								<textarea rows="3" name="@d.c[0].fld" id="@d.c[0].v" class="span11"></textarea>
								}
								else if(t=="4")
								{
								<input type="checkbox" name="@d.c[0].fld" id="@d.c[0].v"/><span class="lbl"></span>
								}
								else if(t=="5")
								{
								<textarea name="@d.c[0].fld" id="@d.c[0].v" class="span12 text_editor@(hide)"></textarea>
								}
								</div>
								break;
							}
						}
					}
					</div>
				</div>
			</form>
		</div>
	</div>
}

@{var varchar="@section scripts{";}
@varchar
<script type="text/javascript">
	@foreach(var json in Model.jsons)
	{
		<text>
		$.post("@json.url",{ran:Math.random()},function(r)
		{
			$(function()
			{
				BindToSelect(r);
				BindToDiv(r);
			});
		});
		</text>
	}
	
	@* 优先初始化select控件的option *@
		function BindToSelect(data)
		{
			@foreach(var bind in Model.binds)
		    {
		        if(bind.type=="2")
		        {
		            foreach(var json in Model.jsons)
		            {
		                foreach(var d in json.data)
		                {
		                    if(d.c[0].v==bind.data[0].c[0].v)
		                    {
		                        <text>
								var sel=$("#@(bind.data[1].c[0].v)");
		                        var items=data.@d.c[0].fld;
								$(items).each(function () {
									sel.append("<option value='"+this.v+"'>"+this.k+"</option>");
								});
		                        </text>
		                    }
		                }
		            }
		        }
		    }
		}

        function BindToDiv(data)
        {
            @foreach(var bind in Model.binds)
            {
                if(bind.type=="1")
                {
                    foreach(var json in Model.jsons)
                    {
                        foreach(var d in json.data)
                        {
                            if(d.c[0].v==bind.data[0].c[0].v)
                            {
                                if(d.c[2].t=="-1")
                                {
                                    <text>
                                    $("#@(bind.data[1].c[0].v)").bindEntity(data);
                                    </text>
                                }
                                else
                                {
                                    <text>
                                    $("#@(bind.data[1].c[0].v)").bindEntity(data.@(d.c[0].fld));
                                    </text>
                                }
                            }
                        }
                    }

                }
            }
        }

        $(function()
        {
            @foreach(var table in Model.tables)
            {
                <text>
                $("#@table.id").datagrid({ url: "@table.data.url",psize:@table.data.pagesize });
                </text>
                @foreach(var h in table.data.headers)
                {
                    if(h.type=="2")
                    {
                        foreach(var btn in h.actionbtns)
                        {
                            if(btn.type=="edit")
                            {
                                <text>
								$("#@table.id").parent().find(".btn-table-add").bind('click',function()
								{
									$("#@btn.formdataid").bindEntity({});
									$("#@btn.formdataid").open("新增",function(win)
                                    {
                                        if(!tt.validateForm("@btn.formdataid"))
                                        {
                                            return false;
                                        }
                                        var update=$("#@btn.formdataid").getContext();
                                        $.post("@btn.action",update,function(r)
                                        {
                                            r = $.toJsResult(r);
                                            if(r.ID>0)
                                            {
                                                $("#@table.id").datagrid("addRow",r);
                                                layer.close(win);
                                            }
                                            else
                                            {
                                                $.error("保存失败，请重试！");
                                            }
                                        });

                                        return false;
                                    });
								});
                                $("#@table.id").datagrid("onEdit", function () {
                                    var json = $("#@table.id").datagrid("getCurrData");
                                    $("#@btn.formdataid").bindEntity(json);
                                    $("#@btn.formdataid").open("编辑",function(win)
                                    {
                                        if(!tt.validateForm("@btn.formdataid"))
                                        {
                                            return false;
                                        }
                                        var update=$("#@btn.formdataid").getContext();
                                        $.post("@btn.action",update,function(r)
                                        {
											var newjson = $.updateJson(json, $.toJsResult(r));
                                            if(r.ID>0)
                                            {
                                                $("#@table.id").datagrid("updateRow",json,newjson);
                                                layer.close(win);
                                            }
                                            else
                                            {
                                                $.error("保存失败，请重试！");
                                            }
                                        });

                                        return false;
                                    });
                                });
                                </text>
                            }
                            else if(btn.type=="delete")
                            {
                                <text>
                                $("#@table.id").datagrid("onDelete", function () {
									$.confirm("确定要删除吗？",function()
									{
										var json = $("#@table.id").datagrid("getCurrData");
                                        $.post("@btn.action",{@table.data.pkey:json["@table.data.pkey"]},function(r)
                                        {
                                            if(r>0)
                                            {
                                                $("#@table.id").datagrid("removeCurrRow");
                                            }
                                            else{
                                                $.error("删除失败，请重试！");
                                            }
                                        });
									});
                                });
                            </text>
                        }
                    }
                }
            }
        }
        });

        /*增加验证信息----------Start*/
		@foreach(var fm in Model.forms)
        {
            foreach(var exd in fm.extdata.extdatas)
            {
				if(fm.isshow=="0")
				{
					<text>
					var f@(exd.dataid)=new tt.Field("@exd.showname","","@exd.dataid").setMsgId("layer-error-msg");
					</text>
				}
				else
				{
					<text>
					var f@(exd.dataid)=new tt.Field("@exd.showname","","@exd.dataid");
					</text>
				}
				
                @foreach(var validate in exd.validates)
                {
					switch(validate.type)
                    {
                        case "required":
                            <text>
							tt.vf.req.add(f@(exd.dataid));
							</text>
                            break;
                        case "number":
                            <text>tt.vf.num.add(f@(exd.dataid));</text>
                            break;
                        case "numint":
                            <text>tt.vf.int.add(f@(exd.dataid));</text>
                            break;
                        case "email":
                            <text>tt.vf.email.add(f@(exd.dataid));</text>
                            break;
                        case "ipaddress":
                            <text>tt.vf.ip.add(f@(exd.dataid));</text>
                            break;
                        case "postcode":
                            <text>tt.vf.postcode.add(f@(exd.dataid));</text>
                            break;
                        case "telnum":
                            <text>tt.vf.tel.add(f@(exd.dataid));</text>
                            break;
                        case "idcard":
                            <text>tt.vf.idcard.add(f@(exd.dataid));</text>
                            break;
                        case "lenvalidate":
                            <text>new tt.LV().set(@validate.minlen, @validate.maxlen).add(f@(exd.dataid));</text>
                            break;
                        case "regvalidate":
                            <text>new tt.RV().set(new RegExp("@validate.regstr"),"输入数据格式错误" ).add(f@(exd.dataid));</text>
                            break;
                    }
                }
            }
        }
        /*增加验证信息----------End*/	
</script>
}