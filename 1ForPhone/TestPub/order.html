<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="css/icon.custom.css"/>
    <link rel="stylesheet" type="text/css" href="css/page.css"/>
</head>
<body> 
	<header class="mui-bar mui-bar-nav top-bar">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="back"></a>
		<a class="mui-icon mui-pull-left" id="prev" style="font-size: 12px;padding: 16px 0px 0px 10px;display: none;">上一页</a>
		<h1 class="mui-title">我的订单</h1>
		<a class="mui-icon mui-pull-right" id="next" style="font-size: 12px;padding: 16px 10px 0px 0px;display: none;">下一页</a>
	</header>
	<div class="mui-content">
		<div id="loading">
    		<img src="images/loading.gif" />
    	</div>
    	<div class="mui-card">
    	    <ul class="mui-table-view" id="orderList">
    	    </ul>
    	</div>
	    <div style="height: 51px;"></div>
	</div>
	<nav class="mui-bar mui-bar-tab bottom-bar">
		<a class="mui-tab-item"  id="home">
			<span class="mui-icon iconfont icon-dingwei"></span>
			<span class="mui-tab-label">旅居首页</span>
		</a>
		<a class="mui-tab-item" id="msg">
			<span class="mui-icon iconfont icon-youjian"></span>
			<span class="mui-tab-label">信息咨询</span>
		</a>
		<a class="mui-tab-item" id="tel"> 
			<span class="mui-icon iconfont icon-dianhua"></span>
			<span class="mui-tab-label">电话咨询</span>
		</a>
		<a class="mui-tab-item" id="qq">
			<span class="mui-icon iconfont icon-qq"></span>
			<span class="mui-tab-label">QQ客服</span>
		</a>
	</nav>
	<script src="js/mui.min.js"></script>
	<script src="js/app.js"></script>
	<script src="js/GOMFrameWork.js" ></script>
	<script type="text/javascript">
		(function($,doc){
			$.init();
			
			$.plusReady(function(){
				var state=app.getState();
				
				var prevBtn=doc.getElementById("prev");
				var nextBtn=doc.getElementById("next");
				var backBtn=doc.getElementById("back");
				
				prevBtn.addEventListener("tap",function(){
					loadOrder(currpage-1);
				},false);
				
				nextBtn.addEventListener("tap",function(){
					loadOrder(currpage+1);
				},false);
				
				var cancelBook=function(bookid,srcLi){
					$.post(getUrl("/Phone/CancelBook"),{ID:bookid,ran_g:Math.random()},function(r){
						if(r==1){
							plus.nativeUI.toast('已成功退订房间');
							srcLi.remove();
						}
						else if(r==0){
							plus.nativeUI.toast('对不起,该房间不能退订');
						}
					});
				};
				
				var currpage=0;
				var loadOrder=function(page){
					currpage=page;
					$.getJSON(getUrl("/Phone/LoadUserOrders"),{uid:state.uid,page:page,ran:Math.random()},function(r){
						doc.getElementById("loading").style.display="none";
						
						if(r.PageCount>currpage){
							nextBtn.style.display="block";
						}
						else{
							nextBtn.style.display="none";
						}
						
						if(currpage>1){
							backBtn.style.display="none";
							prevBtn.style.display="block";
						}
						else{
							backBtn.style.display="block";
							prevBtn.style.display="none";
						}
						
						var html="";
						var list=toJsResult(r.List);
						for (var i = 0; i < list.length; ++i) {
	                    	html += '<li class="mui-table-view-cell"><table width="100%"><tr><td colspan="3">'+list[i].RoomName_G+'<a class="mui-pull-right">'+list[i].VillageName_G+'</a></td></tr><tr><td><p>入住日期：'+list[i].BookStartTime_G+'</p><p>离开日期：'+list[i].BookEndTime_G+'</p></td><td><a>共 '+list[i].BookDays_G+' 天&nbsp;&nbsp;&nbsp;&nbsp;￥'+list[i].AllPrice_G+'</a></td><td align="right" width="1%">'+(list[i].CanCancelBook_G==1?'<button type="button" class="mui-btn mui-btn-blue cancelbook" data-id="'+list[i].ID+'">退订</button>':'<button type="button" class="mui-btn"  disabled="disabled">退订</button>')+'</td></tr></table></li>';
	                	}
						doc.getElementById("orderList").innerHTML=html;
						
						var cbooks= doc.getElementsByClassName("cancelbook");
						for(var i=0;i<cbooks.length;++i){
							cbooks[i].addEventListener("tap",function(){
								var srcLi=this.parentElement.parentElement.parentElement.parentElement.parentElement;
								var bookid=this.getAttribute("data-id");
								plus.nativeUI.confirm("确定要取消预定吗？",function(event){
									if(event.index==0){
										cancelBook(bookid,srcLi);
									}
								},"消息提示",['确定','取消']);
							},false);
						}
					});
				};
				
				if(state.uid){
					loadOrder(1);
				}
				
				var home=doc.getElementById("home");
		    	home.addEventListener("tap",function(){
		    		$.back();
		    	},false);
		    	
				//初始化底部Bar功能
				initBottomBarFunc(doc);
			
			});
		}(mui,document))
	</script>
</body>
</html>