@{
    ViewBag.Title = "会员中心";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div style="padding:0px 35px;">
    <img src="~/Images/leader.gif" />
    <div style="margin-top:10px;" id="panel_container">
        <a href="#" onclick="LoginClick()">
            <div class="panel">
                <img src="~/Images/login.jpg" class="traveImg" />
                <div class="traveTitle"><i>会员登录</i></div>
            </div>
        </a>
        <a href="#" onclick="RegClick()">
            <div class="panel">
                <img src="~/Images/register.jpg" />
                <div class="traveTitle"><i>会员注册</i></div>
            </div>
        </a>
        <a href="#" onclick="AgenterSearch()">
            <div class="panel">
                <img src="~/Images/agentersearch.jpg" />
                <div class="traveTitle"><i>代理人查询</i></div>
            </div>
        </a>
        <a href="/Member/TraveGuide">
            <div class="panel">
                <img src="~/Images/traveguid.jpg" />
                <div class="traveTitle"><i>旅居指南</i></div>
            </div>
        </a>
    </div>
    <div class="clear"></div>
</div>

<div class="form-horizontal span6" id="loginDiv">
    <div class="control-group">
        <label class="control-label">用户名：</label>
        <div class="controls">
            <input type="text" id="username" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">密&nbsp;&nbsp;&nbsp;码：</label>
        <div class="controls">
            <input type="password" id="userpsw" maxlength="20" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">验证码：</label>
        <div class="controls">
            <input type="text" id="tpyzm" style="width:120px;" />
            <img class="help-inline" id="yzm_img" width="78" src="/Base/GetYzmImg" style="border:solid 1px #ddd;"
                 title="点击更换验证码" alt="验证码" onclick="changeYzmImg()" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label"></label>
        <div class="controls">
            <input type="checkbox" checked="checked" id="keepactive" />
            <label class="lbl" for="keepactive"> 记住我</label>
            <a style="margin-left: 40px;" href="javascript://void(0)" onclick="reguser()">免费注册</a> | <a href="javascript://void(0)"
                                                                                                        onclick="findpsw()">忘记密码</a>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label"></label>
        <div class="controls">
            <input id="btn_login" class="btn btn-danger" type="button" value="登&nbsp;&nbsp;录" onclick="submitlogin()" style="width:220px;" />
        </div>
    </div>

</div>

<div class="form-horizontal span6" id="regDiv">
    <div class="control-group">
        <label class="control-label">用 户 名：</label>
        <div class="controls">
            <input type="text" id="regusername" onblur="checkregUserName(this)" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">手机号码：</label>
        <div class="controls">
            <input type="text" id="phone" value="" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">密&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;码：</label>
        <div class="controls">
            <input type="password" id="reguserpsw" maxlength="20" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">重复密码：</label>
        <div class="controls">
            <input type="password" id="againuserpsw" maxlength="20" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">短信验证码：</label>
        <div class="controls">
            <input type="text" id="msgcode" maxlength="6" style="width:120px;" />
            <input type="button" value="获取验证码" class="btn noradius btn-msgcode" style="width:80px;padding:0px;" data-type="1" data-target="phone" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label"></label>
        <div class="controls">
            <input type="button" value="注&nbsp;&nbsp;册" onclick="submitreg()" class="btn btn-danger" style="width:220px;" />
        </div>
    </div>
</div>

<!--忘记密码-->
<div class="form-horizontal span6" id="findPsw">
    <div class="control-group">
        <label class="control-label">手机号码：</label>
        <div class="controls">
            <input type="text" id="find-phone" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">短信验证码：</label>
        <div class="controls">
            <input type="text" id="find-yzm" maxlength="6" style="width:120px;" />
            <input type="button" value="获取验证码" class="btn noradius btn-msgcode" style="width:80px;padding:0px;" data-type="2" data-target="find-phone" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">新密码：</label>
        <div class="controls">
            <input type="password" id="find-newpwd" maxlength="20" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">重复密码：</label>
        <div class="controls">
            <input type="password" id="find-againpwd" maxlength="20" />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label"></label>
        <div class="controls">
            <input type="button" value="确&nbsp;&nbsp;定" onclick="findpswsubmit()" class="btn btn-danger" style="width:220px;" />
        </div>
    </div>
</div>

<div style="width:800px;display:none;padding:0px 20px;" id="agenterDiv">
    <p style="border-bottom:dashed 1px #ddd;padding:10px 0px;">代理人姓名：<input type="text" id="agenterName" style="margin-bottom:0px;" /><input id="btnSearchAgenter" type="button" value=" 查  询 " class="btn btn-primary noradius" style="height:30px;" /></p>
    <div id="agenterInfo" style="height:400px;overflow-y:auto;"></div>
</div>

<div id="div_ChangePsw" style="width:350px;padding:30px 0px 0px 50px;display:none;">
    <table>
        <tr><td>旧&nbsp;&nbsp; 密 &nbsp;&nbsp;码：</td><td><input type="password" id="u_oldpsw" /></td></tr>
        <tr><td>新&nbsp;&nbsp; 密 &nbsp;&nbsp;码：</td><td><input type="password" id="u_newpsw" /></td></tr>
        <tr><td>重复新密码：</td><td><input type="password" id="u_tnewpsw" /></td></tr>
    </table>
</div>

@section styles{
    <link href="~/Scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Scripts/ace/css/ace.min.css" rel="stylesheet" />
    <style type="text/css">
        .form-horizontal .control-label {
            width: 120px;
        }

        .form-horizontal .controls {
            margin-left: 130px;
        }

        #loginDiv, #regDiv, #findPsw {
            display: none;
            font-size: 12px;
            padding-top: 40px;
        }

        #layer-error-msg {
            float: left;
            padding-left: 10px;
        }

        .traveTitle {
            width: 83px;
            text-align: center;
            padding: 3px 0px;
            background-color: red;
            opacity: 0.7;
            color: white;
            font-weight: bolder;
            font-size: 15px;
            margin-top: -42px;
        }
    </style>
}

@section scripts{
    <script src="~/Scripts/layer/layer.js"></script>
    <script src="~/Scripts/website/page.js"></script>
    <script type="text/javascript">
        setCurrMenu(2);

        @if(ViewBag.IsLogin!=null)
        {
            <text>
        changeUIWhenIsLogin();
        </text>
        }

        var ophone = null;
        $(".btn-msgcode").bind('click', function () {
            var targetid = $(this).attr("data-target");
            var phone = $.trim($("#" + targetid).val());
            if (phone.length == 0) {
                $.error("手机号码不能为空！");
                return;
            }
            if (!(/^[1][3,5,8][0-9]{9}$/g).test(phone)) {
                $.error("请输入有效的手机号码！");
                return;
            }

            var type = $(this).attr("data-type");

            this.disabled = "disabled";
            var src = this;
            $.post("/Member/SendMsgCode", { phone: phone, type: type, ran: Math.random() }, function (r) {
                src.disabled = "";
                if (r == -1) {
                    $.error("手机号码输入错误！");
                    return;
                }

                if (r == 9) {
                    $.error("该手机号码已被注册！");
                }
                else if (r == 1) {
                    ophone = phone;
                    $.success("短信验证码已发送成功。");
                }
                else if (r == 0) {
                    $.error("短信验证码发送失败，请重试！");
                }
            });
        });

        function changeYzmImg() {
            $("#yzm_img").attr("src", "/Base/GetYzmImg/" + Math.random().toString().split('.')[1]);
        }

        var layerLogin = null;
        function LoginClick() {
            layerLogin = $("#loginDiv").open("会员登录");
        }

        var layerReg = null;
        function RegClick() {
            layerReg = $("#regDiv").open("会员注册");
        }

        var layerFind = null;
        function findpsw() {
            layerFind = $("#findPsw").open("找回密码");
        }

        function reguser() {
            layer.close(layerLogin);
            RegClick();
        }

        function submitlogin() {
            var username = $.trim($("#username").val());
            var userpsw = $.trim($("#userpsw").val());
            var yzm = $.trim($("#tpyzm").val());
            if (username.length == 0) {
                $.error("用户名不能为空！");
                return;
            }

            if (userpsw.length == 0) {
                $.error("密码不能为空！");
                return;
            }
            if (yzm.length == 0) {
                $.error("验证码不能为空！");
                return;
            }

            var isRem = $("#keepactive")[0].checked ? 1 : 0;
            $.post("/Member/MemberLogin", { username: username, userpsw: userpsw, yzm: yzm, isrem: isRem, ran: Math.random() }, function (r) {
                if (r == -2) {
                    $.error("验证码错误！");
                    $("#tpyzm").val("");
                    $("#tpyzm")[0].focus();
                }
                else if (r == -1) {
                    $.error("用户名不存在！");
                }
                else if (r == 0) {
                    $.error("用户名或密码错误！");
                }
                else if (r == 1) {
                    layer.close(layerLogin);
                    changeUIWhenIsLogin();
                    @if(ViewBag.ReturnUrl !=null)
                    {
                        <text>
                    location.href = "@ViewBag.ReturnUrl";
                    </text>
                    }
                }
            });
        }

        function submitreg() {
            var username = $.trim($("#regusername").val());
            var userpsw = $.trim($("#reguserpsw").val());
            if (username.length == 0) {
                $.error("用户名不能为空！");
                return;
            }
            if (username.length < 6) {
                $.error("用户名至少为6为字符！");
                return;
            }

            var phone = $.trim($("#phone").val());
            if (phone.length == 0) {
                $.error("手机号码不能为空！");
                return;
            }
            if (!(/^[1][3,5,8][0-9]{9}$/g).test(phone)) {
                $.error("请输入有效的手机号码！");
                return;
            }

            if (userpsw.length == 0) {
                $.error("密码不能为空！");
                return;
            }
            if (userpsw != $.trim($("#againuserpsw").val())) {
                $.error("两次密码不相同！");
                return;
            }

            var msgcode = $.trim($("#msgcode").val());
            if (msgcode.length == 0) {
                $.error("请输入短信验证码！");
                return;
            }
            if (ophone && ophone != phone) {
                $.error("短信验证码输入错误！");
                return;
            }

            $.post("/Member/MemberReg", { username: username, userpsw: userpsw, phone: phone, msgcode: msgcode, ran: Math.random() }, function (r) {
                if (r == -1) {
                    $.error("用户名已存在！");
                }
                else if (r == -3) {
                    $.error("请获取短信验证码后重新输入！");
                }
                else if (r == -4) {
                    $.error("短信验证码输入错误！");
                }
                else if (r > 0) {
                    layer.close(layerReg);
                    LoginClick();
                }
                else {
                    $.error("注册失败，请重试！");
                }
            });
        }

        function findpswsubmit() {
            var phone = $.trim($("#find-phone").val());
            if (phone.length == 0) {
                $.error("手机号码不能为空！");
                return;
            }
            if (!(/^[1][3,5,8][0-9]{9}$/g).test(phone)) {
                $.error("请输入有效的手机号码！");
                return;
            }

            var msgcode = $.trim($("#find-yzm").val());
            if (msgcode.length == 0) {
                $.error("请输入短信验证码！");
                return;
            }
            if (ophone && ophone != phone) {
                $.error("短信验证码输入错误！");
                return;
            }

            var userpsw = $.trim($("#find-newpwd").val());
            if (userpsw.length == 0) {
                $.error("密码不能为空！");
                return;
            }
            if (userpsw != $.trim($("#find-againpwd").val())) {
                $.error("两次密码不相同！");
                return;
            }

            $.post("/Member/FindPsw", { phone: phone, psw: userpsw, msgcode: msgcode, ran: Math.random() }, function (r) {
                if (r == 1) {
                    layer.close(layerFind);
                    $.success("密码重置成功，请登录。");
                }
                else if (r == -1) {
                    $.error("请输入手机号码！");
                }
                else if (r == -2) {
                    $.error("请获取短信验证码后重新输入！");
                }
                else if (r == -3) {
                    $.error("短信验证码输入错误！");
                }
                else if (r == -4) {
                    $.error("手机号码未注册！");
                }
                else if (r == 0) {
                    $.error("重置密码失败，请重试！");
                }
            });
        }

        function checkregUserName(src) {
            var username = $.trim($(src).val());
            if (username.length == 0 || username.length < 6) {
                return;
            }

            $.post("/Member/IsMemberExist", { username: username, ran: Math.random() }, function (r) {
                if (r == 1) {
                    $.error("用户名已存在！");
                }
            });
        }

        function changeUIWhenIsLogin() {
            var links = $("#panel_container a");
            var cpswobj = $('<a href="#" onclick="ChangePsw()" id="panel_ChangePsw"><div class="panel"><img src="/Images/changePsw.jpg" class="traveImg" /><div class="traveTitle"><i>修改密码</i></div></div></a>');
            cpswobj.insertAfter(links.eq(0));

            links.eq(0).remove();
            links.eq(1).remove();

            var orderobj = $('<a href="/Member/OrderIndex"><div class="panel"><img src="/Images/order.jpg" /><div class="traveTitle"><i>我的订单</i></div></div></a>');
            orderobj.insertAfter(cpswobj);
        }

        function AgenterSearch() {
            $("#agenterDiv").open("代理人查询");
        }

        $(function () {
            $("#btnSearchAgenter").bind("click", function () {
                var name = $.trim($("#agenterName").val());
                if (name.length == 0) {
                    return;
                }

                $.post("/Member/SearchAgenter", { name: name }, function (r) {
                    $("#agenterInfo").loaded();

                    if (r.length == 0) {
                        $("#agenterInfo").html("<p style='line-height:300px;text-align:center;color:gray;'>查询不到代理人信息！</p>");
                    }
                    else {
                        $("#agenterInfo").html(r);
                    }
                });
            });
        });

        function ChangePsw() {
            $("#div_ChangePsw").open("修改密码", function (idx) {
                var oldpsw = $.trim($("#u_oldpsw").val());
                var newpsw = $.trim($("#u_newpsw").val());
                var tnewpsw = $.trim($("#u_tnewpsw").val());
                if (oldpsw.length == 0) {
                    ShowMsg("旧密码不能为空！");
                    return false;
                }

                if (newpsw.length == 0) {
                    ShowMsg("新密码不能为空！");
                    return false;
                }

                if (newpsw != tnewpsw) {
                    ShowMsg("两次新密码不相同！");
                    return false;
                }

                $.post("/Member/ChangeUserPsw", { oldPsw: oldpsw, newPsw: newpsw, ran: Math.random() }, function (r) {
                    if (r > 0) {
                        layer.close(idx);
                        $.success("密码修改成功。");
                    }
                    else {
                        ShowMsg("旧密码错误！");
                    }
                });

                return false;
            });
        }
        function ShowMsg(msg) {
            if (msg.length == 0) {
                $("#layer-error-msg").html("");
            }
            else {
                $("#layer-error-msg").html('<span class="alert alert-error" style="font-size: 11px; padding: 3px 15px 3px 5px;color:#e32c2d;"><i class="fa fa-warning"></i> ' + msg + '</span>');
            }
        }

        @if(ViewBag.Action!=null&&ViewBag.Action=="login")
        {
            <text>
        LoginClick();
        </text>
        }
    </script>
}
