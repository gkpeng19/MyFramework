@{
    ViewBag.Title = "会员中心";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div style="padding:0px 35px;">
    <img src="~/Images/leader.gif" />
    <div style="margin-top:10px;" id="panel_container">
        <a href="#" onclick="LoginClick()">
            <div class="panel">
                <img src="~/Images/login.jpg" class="traveImg" />
                <div class="traveTitle"><i>会员登录</i></div>
            </div>
        </a>
        <a href="#" onclick="RegClick()">
            <div class="panel">
                <img src="~/Images/register.jpg" />
                <div class="traveTitle"><i>会员注册</i></div>
            </div>
        </a>
        <a href="#" onclick="AgenterSearch()">
            <div class="panel">
                <img src="~/Images/agentersearch.jpg" />
                <div class="traveTitle"><i>代理人查询</i></div>
            </div>
        </a>
        <a href="/Member/TraveGuide">
            <div class="panel">
                <img src="~/Images/traveguid.jpg" />
                <div class="traveTitle"><i>旅居指南</i></div>
            </div>
        </a>
    </div>
    <div class="clear"></div>
</div>

<table border="0" cellpadding="0" cellspacing="0" id="loginDiv">
    <tr>
        <td>
            <label for="username">用户名：</label>
        </td>
        <td>
            <input type="text" id="username" />
        </td>
    </tr>
    <tr>
        <td>
            <label for="userpsw">密&nbsp;&nbsp;&nbsp;码：</label>
        </td>
        <td>
            <input type="password" id="userpsw" maxlength="20" />
        </td>
    </tr>
    <tr>
        <td>
            <label for="tpyzm">验证码：</label>
        </td>
        <td>
            <input type="text" id="tpyzm" style="width:139px;position:relative;top:-5px;" />
            <img id="yzm_img" height="25" src="/Base/GetYzmImg" style="border:solid 1px #ddd;position:relative;top:3px;"
                 title="点击更换验证码" alt="验证码" onclick="changeYzmImg()" />
        </td>
    </tr>
    <tr>
        <td colspan="2" align="center">
            <input type="checkbox" checked="checked" id="keepactive" />  <label for="keepactive" style="position:relative;top:-3px;">记住我</label>
            <a style="margin-left: 60px;" href="javascript://void(0)" onclick="reguser()">免费注册</a> | <a href="javascript://void(0)"
                                                                                                        onclick="findpsw()">忘记密码</a>
        </td>
    </tr>
    <tr>
        <td colspan="2" align="center">
            <input id="btn_login" type="button" value="登&nbsp;&nbsp;录" onclick="submitlogin()" />
        </td>
    </tr>
</table>

<table border="0" cellpadding="0" cellspacing="0" id="regDiv">
    <tr>
        <td style="width:6em;">
            <label for="regusername">用 户 名：</label>
        </td>
        <td>
            <input type="text" id="regusername" onblur="checkregUserName(this)" />
        </td>
    </tr>
    <tr>
        <td><label for="phone">手机号码：</label></td>
        <td>
            <input type="text" id="phone" value="" />
        </td>
    </tr>
    <tr>
        <td><label for="reguserpsw">密&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;码：</label></td>
        <td>
            <input type="password" id="reguserpsw" maxlength="20" />
        </td>
    </tr>
    <tr>
        <td><label for="againuserpsw">重复密码：</label></td>
        <td>
            <input type="password" id="againuserpsw" maxlength="20" />
        </td>
    </tr>
    <tr>
        <td colspan="2" align="center" style="padding-top:30px;">
            <input type="button" value="注&nbsp;&nbsp;册" onclick="submitreg()" />
        </td>
    </tr>
</table>

<div style="width:800px;display:none;padding:0px 20px;" id="agenterDiv">
    <p style="border-bottom:dashed 1px #ddd;padding-bottom:10px;"><label for="agenterName" style="font-size:14px;">代理人姓名：</label><input type="text" id="agenterName" /><input id="btnSearchAgenter" type="button" value="查询" style="width:60px;padding:3px;" /></p>
    <div id="agenterInfo" style="height:400px;overflow-y:auto;"></div>
</div>

<div id="div_ChangePsw" style="width:350px;">
    <table>
        <tr><td>旧&nbsp;&nbsp; 密 &nbsp;&nbsp;码：</td><td><input type="password" id="u_oldpsw" /></td></tr>
        <tr><td>新&nbsp;&nbsp; 密 &nbsp;&nbsp;码：</td><td><input type="password" id="u_newpsw" /></td></tr>
        <tr><td>重复新密码：</td><td><input type="password" id="u_tnewpsw" /></td></tr>
    </table>
</div>

@section styles{
    <style type="text/css">
        #loginDiv {
            display: none;
            font-size: 12px;
            padding: 20px 50px;
        }

        #regDiv {
            font-size: 12px;
            display: none;
            padding: 20px 55px;
        }

        #div_ChangePsw {
            display: none;
            font-size: 12px;
            padding: 20px 10px 0px 30px;
        }

        #loginDiv tr td:first-child, #regDiv tr td:first-child {
            width: 4.5em;
        }

        #div_ChangePsw tr td:first-child {
            width: 6.5em;
        }

        #loginDiv td, #regDiv td, #EditDiv td, #ReviseDiv td, #div_ChangePsw td {
            padding: 5px 0px;
        }

        input[type=text], #loginDiv input[type=password], #regDiv input[type=text], input[type=password] {
            padding: 5px;
            width: 220px;
            border: solid 1px #dddddd;
            color: #666666;
        }

        #loginDiv input[type=button], #regDiv input[type=button] {
            width: 230px;
            padding: 5px;
        }

        #layer-error-msg {
            float: left;
            padding-left: 10px;
        }

        .traveTitle {
            width: 83px;
            text-align: center;
            padding: 3px 0px;
            background-color: red;
            opacity: 0.7;
            color: white;
            font-weight: bolder;
            font-size: 15px;
            margin-top: -42px;
        }
    </style>
}

@section scripts{
    <script src="~/Scripts/layer/layer.js"></script>
    <script type="text/javascript">
        setCurrMenu(2);

        @if(ViewBag.IsLogin!=null)
        {
            <text>
        changeUIWhenIsLogin();
        </text>
        }


        function changeYzmImg() {
            $("#yzm_img").attr("src", "/Base/GetYzmImg/" + Math.random().toString().split('.')[1]);
        }

        var layerLogin = null;
        function LoginClick() {
            layerLogin = $("#loginDiv").open("会员登录");
        }

        var layerReg = null;
        function RegClick() {
            layerReg = $("#regDiv").open("会员注册");
        }

        function reguser() {
            layer.close(layerLogin);
            RegClick();
        }

        function submitlogin() {
            var username = $.trim($("#username").val());
            var userpsw = $.trim($("#userpsw").val());
            var yzm = $.trim($("#tpyzm").val());
            if (username.length == 0) {
                $.msg("用户名不能为空！");
                return;
            }

            if (userpsw.length == 0) {
                $.msg("密码不能为空！");
                return;
            }
            if (yzm.length == 0) {
                $.msg("验证码不能为空！");
                return;
            }

            var isRem = $("#keepactive")[0].checked ? 1 : 0;
            $.post("/Member/MemberLogin", { username: username, userpsw: userpsw, yzm: yzm, isrem: isRem, ran: Math.random() }, function (r) {
                if (r == -2) {
                    $.msg("验证码错误！");
                    $("#tpyzm").val("");
                    $("#tpyzm")[0].focus();
                }
                else if (r == -1) {
                    $.msg("用户名不存在！");
                }
                else if (r == 0) {
                    $.msg("用户名或密码错误！");
                }
                else if (r == 1) {
                    layer.close(layerLogin);
                    changeUIWhenIsLogin();
                    @if(ViewBag.ReturnUrl !=null)
                    {
                        <text>
                    location.href = "@ViewBag.ReturnUrl";
                    </text>
                    }
                }
            });
        }

        function submitreg() {
            var username = $.trim($("#regusername").val());
            var userpsw = $.trim($("#reguserpsw").val());
            if (username.length == 0) {
                $.msg("用户名不能为空！");
                return;
            }
            if (username.length < 6) {
                $.msg("用户名至少为6为字符！");
                return;
            }
            if (userpsw.length == 0) {
                $.msg("密码不能为空！");
                return;
            }
            if (userpsw != $.trim($("#againuserpsw").val())) {
                $.msg("两次密码不相同！");
                return;
            }

            var phone = $.trim($("#phone").val());
            if (phone.length == 0) {
                $.msg("手机号码不能为空！");
                return;
            }

            $.post("/Member/MemberReg", { username: username, userpsw: userpsw, phone: phone, ran: Math.random() }, function (r) {
                if (r == -1) {
                    $.msg("用户名已存在！");
                }
                else if (r > 0) {
                    layer.close(layerReg);
                    LoginClick();
                }
                else {
                    $.msg("注册失败，请重试！");
                }
            });
        }

        function checkregUserName(src) {
            var username = $.trim($(src).val());
            if (username.length == 0 || username.length < 6) {
                return;
            }

            $.post("/Member/IsMemberExist", { username: username, ran: Math.random() }, function (r) {
                if (r == 1) {
                    $.msg("用户名已存在！");
                }
            });
        }

        function changeUIWhenIsLogin() {
            var links = $("#panel_container a");
            var cpswobj = $('<a href="#" onclick="ChangePsw()" id="panel_ChangePsw"><div class="panel"><img src="/Images/changePsw.jpg" class="traveImg" /><div class="traveTitle"><i>修改密码</i></div></div></a>');
            cpswobj.insertAfter(links.eq(0));

            links.eq(0).remove();
            links.eq(1).remove();

            var orderobj = $('<a href="/Member/OrderIndex"><div class="panel"><img src="/Images/order.jpg" /><div class="traveTitle"><i>我的订单</i></div></div></a>');
            orderobj.insertAfter(cpswobj);
        }

        function AgenterSearch() {
            $("#agenterDiv").open("代理人查询");
        }

        $(function () {
            $("#btnSearchAgenter").bind("click", function () {
                var name = $.trim($("#agenterName").val());
                if (name.length == 0) {
                    return;
                }

                $.post("/Member/SearchAgenter", { name: name }, function (r) {
                    $("#agenterInfo").loaded();

                    if (r.length == 0) {
                        $("#agenterInfo").html("<p style='line-height:300px;text-align:center;color:gray;'>查询不到代理人信息！</p>");
                    }
                    else {
                        $("#agenterInfo").html(r);
                    }
                });
            });
        });

        function ChangePsw() {
            $("#div_ChangePsw").open("修改密码", function (idx) {
                var oldpsw = $.trim($("#u_oldpsw").val());
                var newpsw = $.trim($("#u_newpsw").val());
                var tnewpsw = $.trim($("#u_tnewpsw").val());
                if (oldpsw.length == 0) {
                    ShowMsg("旧密码不能为空！");
                    return false;
                }

                if (newpsw.length == 0) {
                    ShowMsg("新密码不能为空！");
                    return false;
                }

                if (newpsw != tnewpsw) {
                    ShowMsg("两次新密码不相同！");
                    return false;
                }

                $.post("/Base/ChangeUserPsw", { oldPsw: oldpsw, newPsw: newpsw, ran: Math.random() }, function (r) {
                    if (r > 0) {
                        layer.close(idx);
                        $.success("密码修改成功。");
                    }
                    else {
                        ShowMsg("旧密码错误！");
                    }
                });

                return false;
            });
        }
        function ShowMsg(msg) {
            if (msg.length == 0) {
                $("#layer-error-msg").html("");
            }
            else {
                $("#layer-error-msg").html('<span class="alert alert-error" style="font-size: 11px; padding: 3px 15px 3px 5px;color:#e32c2d;"><i class="fa fa-warning"></i> ' + msg + '</span>');
            }
        }

        @if(ViewBag.Action!=null&&ViewBag.Action=="login")
        {
            <text>
        LoginClick();
        </text>
        }
    </script>
}
