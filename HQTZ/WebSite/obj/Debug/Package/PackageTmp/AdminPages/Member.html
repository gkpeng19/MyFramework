<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <link href="/Scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/Scripts/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" />
    <link href="/Scripts/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/Scripts/validate/css/validate.css" rel="stylesheet" />
    <link href="/Scripts/umeditor/themes/default/css/umeditor.min.css" rel="stylesheet" />
    <link href="/Scripts/ace/css/ace.min.css" rel="stylesheet" />
    <link href="/Scripts/ace/css/ace-responsive.min.css" rel="stylesheet" />
    <link href="/Styles/GOMFrameWork.css" rel="stylesheet" />
    <link href="../Scripts/bootstrap/bootstrap-datepicker.css" rel="stylesheet" />

    <script src="/Scripts/jquery-1.10.2.min.js"></script>
</head>
<body>
    <div class="row-fluid">
        <div class="row-fluid header blue btn-header">
            <div class="span7">
                <label class="btn btn-primary btn-mini" for="file_inp_import"> 导 入 </label>
                <span style="display:none;">
                    <input type="file" id="inp_import" accept="application/vnd.ms-excel" />
                </span>
                <a class="label label-primary" href="../Images/%e4%bc%9a%e5%91%98%e5%af%bc%e5%85%a5%e7%a4%ba%e4%be%8b%e6%96%87%e4%bb%b6.xls" target="_blank">会员导入示例文件下载</a>
                <button class="btn btn-primary btn-mini btn-table-add btn-authority"> 新 增 </button>
                <span class="label label-warning">**默认密码为123456</span>
            </div>
            <div class="span5">
                <div class="dataTables_wrapper" id="table_search" style="text-align:right;">
                    <label>用户名：<input name="UserName" class="input-medium" type="text"></label>
                    <label><input type="button" class="btn btn-primary btn-mini" value="查询" onclick="$('#9739148752935891').datagrid('refresh')" /></label>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table id="9739148752935891" class=" table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th data-option="{sequence:true}">序号</th>
                        <th data-option="{bind:'UserName'}">用户名</th>
                        <th data-option="{bind:'UserType_G'}">用户类型</th>
                        <th data-option="{bind:'PhoneNum'}">手机号码</th>
                        <th data-option="{bind:'ShortBalance_C'}">余额</th>
                        <th data-option="{bind:'MemberMedical'}">健康档案</th>
                        <th data-option="{bind:'CreateOn_G'}">注册时间</th>
                        <th data-option="{edit:true,del:false,onload:OnOptLoading}" class="th-operate">操作</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>


    <div class="row-fluid">
        <div class="span5">
            <form name="8328234406241097" id="8328234406241097" class="layerout form-layer">
                <div>
                    <input type="hidden" name="ID" />
                    <div class="row-fluid">
                        <div class="span12">
                            <label>用户名</label>
                            <input type="text" name="UserName" id="06113260950252164" class="span11" />
                        </div>
                        <div class="span12">
                            <label>手机号码</label>
                            <input type="text" name="PhoneNum" id="6145849120099815" class="span11" />
                        </div>
                        <div class="span12">
                            <label>用户类型</label>
                            <select name="UserType" class="span11">
                                <option value="1">普通会员</option>
                                <option value="2">VIP会员</option>
                            </select>
                        </div>
                        <!--<div class="span12">
                            <label>Email地址</label>
                            <input type="text" name="Email" id="7990550769907716" class="span11" />
                        </div>-->
                        <div class="span12">
                            <label>健康档案</label>
                            <textarea rows="3" class="span11" name="MemberMedical"></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span4">
            <form id="formAddBalance" class="layerout form-layer">
                <div>
                    <div class="row-fluid">
                        <div class="span12">
                            <label>余 额</label>
                            <input type="text" id="txtBalance" class="span11" readonly="readonly" />
                        </div>
                        <div class="span12">
                            <label>充值金额</label>
                            <input type="text" id="txtAddAmount" class="span11" />
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span7">
            <form id="div_book" class=" layerout form-layer">
                <div>
                    <div class="row-fluid">
                        <div class="span6">
                            <label>度假村</label>
                            <select id="sel_vallige" class="span11" name="n_v"></select>
                        </div>
                        <div class="span6">
                            <label>房  间</label>
                            <select id="sel_room" class="span11" name="n_r"></select>
                        </div>
                        <div class="span6">
                            <label>入住日期</label>
                            <input type="text" id="startDate" class="datepicker span11" name="n_bd" data-date-format="yyyy-mm-dd" />
                        </div>
                        <div class="span6">
                            <label>退房日期</label>
                            <input type="text" id="endDate" class="datepicker span11" name="n_ed" data-date-format="yyyy-mm-dd" />
                        </div>
                        <div class="span12">
                            <label>备  注</label>
                            <textarea rows="3" class="span11" name="n_rmk" id="txt_remark"></textarea>
                        </div>
                        <div class="span12" style="margin-top:5px;">
                            会员余额：<span id="span_balance"></span> &nbsp;&nbsp;
                            门店价：<span id="span_price">...</span> &nbsp;&nbsp;
                            VIP价：<span id="span_vipprice">...</span> &nbsp;&nbsp;
                            入住天数： <span id="span_days">0</span>天 &nbsp;&nbsp;
                            总消费：<span id="span_amount">0</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <script src="/Scripts/bootstrap/js/bootstrap.min.js"></script>
    <script src="../Scripts/bootstrap/bootstrap-datepicker.min.js"></script>
    <script src="/Scripts/layer/layer.js"></script>
    <script src="/Scripts/umeditor/umeditor.config.js"></script>
    <script src="/Scripts/umeditor/umeditor.min.js"></script>
    <script src="/Scripts/umeditor/lang/zh-cn/zh-cn.js"></script>
    <script src="/Scripts/validate/talent-validate-all-init.js"></script>
    <script src="/Scripts/ace/ace.min.js"></script>
    <script src="/Scripts/GOMFrameWork.js"></script>
    <script type="text/javascript">
        $("#inp_import").upload({
            filter: "application",
            uploadUrl: "/Scripts/umeditor/net/fileUp.ashx?iseditor=0",
            maxSize: 10,
            success: function (r) {
                $("#9739148752935891").loading();
                $.post("/AdminMember/ImportMember", { fpath: r.path }, function (r) {
                    $("#9739148752935891").loaded();
                    if (r > 0) {
                        $.success("导入成功。");
                        $('#9739148752935891').datagrid('refresh');
                    }
                    else {
                        $.error("导入失败，未知错误！");
                    }
                });
            }
        });

        var _isVip = false;
        $("#startDate").datepicker({ startDate: new Date().toLocaleDateString(), autoclose: true });
        $("#endDate").datepicker({ startDate: new Date().toLocaleDateString(), autoclose: true });
        $("#startDate").bind("change", function () {
            onDateChanged();
        });
        $("#endDate").bind("change", function () {
            onDateChanged();
        });

        function onDateChanged() {
            var start = $("#startDate").val();
            var end = $("#endDate").val();
            if (start.length == 0 || end.length == 0 || start == end) {
                $("#span_days").text(0);
                $("#span_amount").text(0);
            }
            else {
                start = new Date(start.replace("-", "/").replace("-", "/"));
                end = new Date(end.replace("-", "/").replace("-", "/"));
                var days = (end - start) / 1000 / 3600 / 24;
                $("#span_days").text(days);
                var price = _isVip ? $("#span_vipprice").text() : $("#span_price").text();
                $("#span_amount").text(days * price);
            }
        };

        $("#sel_vallige").bind("change", function () {
            $.post("/VillageRoom/LoadRoomList", { VillageID: this.value, page_g: 1, psize_g: 9999 }, function (r) {
                var sel = $("#sel_room");
                r = $.toJsResult(r.Data);
                sel.find("option").remove();
                $(r).each(function () {
                    sel.append("<option value='" + this.ID + "' data-price='" + this.Price + "' data-vipprice='" + this.VipPrice + "'>" + this.Name + "</option>");
                });
                $("#sel_room").trigger("change");
                $("#endDate").trigger("change");
            });
        });

        $("#sel_room").bind("change", function () {
            var price = $(this).find("option:selected").attr("data-price");
            var vipprice = $(this).find("option:selected").attr("data-vipprice");
            $("#span_price").text(price);
            $("#span_vipprice").text(vipprice);
        });

        $.post("/VillageRoom/LoadJsonData", { ran: Math.random() }, function (data) {
            var sel = $("#sel_vallige");
            var items = data.Villages;
            $(items).each(function () {
                sel.append("<option value='" + this.v + "'>" + this.k + "</option>");
            });
            $("#sel_vallige").trigger("change");
        });

        function OnOptLoading(json, html) {
            if (json.IsDelete == 1) {
                html += ' <a href="javascript:void(0)" class="btn btn-minier btn-danger" onclick="UseNMember(0)">启用</a> ';
            }
            else {
                html += ' <a href="javascript:void(0)" class="btn btn-minier btn-danger" onclick="UseNMember(1)">禁用</a> ';
            }
            html += ' <a href="javascript:void(0)" class="btn btn-minier btn-success" onclick="AddBalance(' + json.ShopUserID_G + ',' + json.Balance_G + ')">充值</a> ';
            html += ' <a href="javascript:void(0)" class="btn btn-minier btn-info" onclick="Book(' + json.ID + ',' + json.ShortBalance_C + ',' + json.UserType + ')">预订</a> ';
            return html;
        }

        function UseNMember(toState) {
            var title = toState == 0 ? "启用" : "禁用";
            $.confirm("确定要" + title + "该用户吗？", function () {
                var json = $("#9739148752935891").datagrid("getCurrData");
                var newjson = { ID: json.ID, IsDelete: toState };
                $.post("/AdminMember/UseNMember", newjson, function (r) {
                    if (r > 0) {
                        $("#9739148752935891").datagrid("refresh");
                        $.success(title + "成功。");
                    }
                    else {
                        $.error(title + "失败，请重试！");
                    }
                });
            });
        }

        function AddBalance(shopUserId, balance) {
            $("#txtBalance").val(balance);
            $("#txtAddAmount").val("");
            $("#formAddBalance").open("充值", function () {
                var addAmount = $("#txtAddAmount").val();
                addAmount = parseFloat(addAmount);
                if (!addAmount || addAmount == 0) {
                    $.error("充值金额填写错误！");
                    return false;
                }
                $.post("/AdminMember/AddBlance", { shopUserId: shopUserId, amount: addAmount, ran: Math.random() }, function (r) {
                    if (r > 0) {
                        layer.closeAll();
                        $("#9739148752935891").datagrid("refresh");
                        $.success("充值成功。");
                    }
                    else {
                        $.error("充值失败，请重试！");
                    }
                });

                return false;
            });
        }

        function Book(userid, balance, utype) {
            _isVip = utype == 1 ? false : true;
            $("#span_balance").text(balance);
            $("#div_book").bindEntity({});
            $("#div_book").open("预订", function () {
                var start = $("#startDate").val();
                var end = $("#endDate").val();
                if (start.length == 0) {
                    $.error("请填写入住日期！");
                    return false;
                }
                if (end.length == 0) {
                    $.error("请填写退房日期！");
                    return false;
                }
                start = new Date(start.replace("-", "/").replace("-", "/"));
                end = new Date(end.replace("-", "/").replace("-", "/"));
                var days = (end - start) / 1000 / 3600 / 24;
                if (days <= 0) {
                    $.error("退房日期必须大于入住日期！");
                    return false;
                }
                var balance = $("#span_balance").text() - $("#span_amount").text();
                if (balance < 0) {
                    $.error("会员余额不足，请联系会员充值！");
                    return false;
                }
                $.post("/AdminMember/HelpMemBook", {
                    memid: userid, roomid: $("#sel_room").val(),
                    sdate: $("#startDate").val(), edate: $("#endDate").val(), remark: $("#txt_remark").val()
                }, function (r) {
                    if (r.ResultID == 1) {
                        layer.closeAll();
                        $.success(r.Message);
                    }
                    else {
                        $.error(r.Message);
                    }
                });

                return false;
            });
        }

        $(function () {


            $("#9739148752935891").datagrid({ url: "/AdminMember/LoadMemberList", search: '#table_search', psize: 10 });

            $("#9739148752935891").parent().prev().find(".btn-table-add").bind('click', function () {
                $("#06113260950252164").removeAttr("readonly");
                $("#8328234406241097").bindEntity({});
                $("#8328234406241097").open("新增", function (win) {
                    if (!tt.validateForm("8328234406241097")) {
                        return false;
                    }
                    var update = $("#8328234406241097").getContext();
                    $.post("/AdminMember/SaveMember", update, function (r) {
                        r = $.combineJson(update, $.toJsResult(r));
                        if (r.ID > 0) {
                            $("#9739148752935891").datagrid("addRow", r);
                            layer.close(win);
                        }
                        else if (r.ID == -1) {
                            $.error("用户名已存在，请更换用户名！");
                        }
                        else if (r.ID == -2) {
                            $.error("手机号码已存在！");
                        }
                        else {
                            $.error("保存失败，请重试！");
                        }
                    });

                    return false;
                });
            });


            $("#9739148752935891").datagrid("onEdit", function () {
                var json = $("#9739148752935891").datagrid("getCurrData");
                $("#06113260950252164").attr("readonly", "readonly");
                $("#8328234406241097").bindEntity(json);
                $("#8328234406241097").open("编辑", function (win) {
                    if (!tt.validateForm("8328234406241097")) {
                        return false;
                    }
                    var update = $("#8328234406241097").getContext();
                    $.post("/AdminMember/SaveMember", update, function (r) {
                        var newjson = $.combineJson(json, update, $.toJsResult(r));
                        if (r.ID > 0) {
                            $("#9739148752935891").datagrid("updateRow", json, newjson);
                            layer.close(win);
                        }
                        else if (r.ID == -1) {
                            $.error("用户名已存在，请更换用户名！");
                        }
                        else if (r.ID == -2) {
                            $.error("手机号码已存在！");
                        }
                        else {
                            $.error("保存失败，请重试！");
                        }
                    });

                    return false;
                });
            });

        });

        /*增加验证信息----------Start*/

        var f06113260950252164 = new tt.Field("用户名", "", "06113260950252164").setMsgId("layer-error-msg");


        tt.vf.req.add(f06113260950252164);


        var f6145849120099815 = new tt.Field("手机号码", "", "6145849120099815").setMsgId("layer-error-msg");


        tt.vf.req.add(f6145849120099815);
        new tt.RV().set(new RegExp("^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$"), "数据格式错误").add(f6145849120099815);

        var f7990550769907716 = new tt.Field("Email地址", "", "7990550769907716").setMsgId("layer-error-msg");


        tt.vf.req.add(f7990550769907716);

        tt.vf.email.add(f7990550769907716);

        /*增加验证信息----------End*/

    </script>
</body>
</html>